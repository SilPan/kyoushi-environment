
- type: elasticsearch.query
  id: dnsteal.domain.match
  labels:
    - dnsteal
    - attacker
  description: >-
    This rule simply matches all DNS queries and answers that end with the
    sub domain used in the dnsteal exfiltration. Now this rule only works
    if we assume that users will not query our malicious sub-domain which is
    a reasonable assumption, if the testbed scenario includes a simulated 
    SOC or some other response team then would have to do some more filtering.
    For example we could use sequence queries to match requests to dnsteal server
    log lines or do negative matches with the simulated user logs.
  index:
    - dnsmasq-inet-firewall
  query:
    bool:
      # match answer or question field
      should:
        - regexp:
            dns.answers.name: '.*\.wtulqzvb\.at'
        - regexp:
            dns.question.name: '.*\.wtulqzvb\.at'


- type: elasticsearch.query
  id: dnsteal.domain.received
  labels: [dnsteal-received]
  description: >-
    This rule applies the dnsteal received label to all dnsteal marked
    log lines that occurred while the dnsteal server was active.
  index:
    - dnsmasq-inet-firewall
  filter:
    range:
      "@timestamp":
        # dnsteal start up time (this is probably before observation start)
        gte: "2021-03-29T12:28:30.371Z"
        # dnsteal stop time
        lte: "2021-03-31T23:30:00.281Z"
  # only apply to lines that are marked dnsteal
  query:
    match:
      kyoushi_labels.rules: dnsteal.domain.match


- type: elasticsearch.query
  id: dnsteal.domain.dropped
  labels: [dnsteal-dropped]
  description: >-
    This rule applies the dnsteal dropped label to all dnsteal marked
    log lines that occurred while the dnsteal server was inactive.
    We define this time range to be from the moment dnsteal stopped until
    the exfiltration service stopped.
  index:
    - dnsmasq-inet-firewall
  filter:
    range:
      "@timestamp":
        # dnsteal stop time (note this is matched without equality)
        gt: "2021-03-31T23:30:00.281Z"
        # exfiltration service stop
        lte: "2021-04-01T00:38:33.148Z"
  # only apply to lines that are marked dnsteal
  query:
    match:
      kyoushi_labels.rules: dnsteal.domain.match